# DNAm Target Panel Analysis Pipeline

This pipeline enables the analysis of DNA methylation data generated from **any DNAm target panel**.
While the example provided here uses the [DNAm lung cancer screening panel](https://github.com/MRCIEU/dnam-lung-cancer-screening-panel), the pipeline can be easily adapted for other custom or published DNAm panels by providing an appropriate `panel.csv` file.

> **Data privacy note**
> The example phenotype file supplied with this repository (`phenotype.csv`) is **entirely simulated**. 
> It contains no real participant information and is generated by the `test-data.sh` script solely for demonstration and unitâ€‘testing purposes.

---

## 1. Phenotype Matrix (`phenotype.csv`)

* **Simulated data:** `phenotype.csv` contains *synthetic* phenotype records that mimic the required file structure, matched to **20** publicly available DNAm samples downloaded from the ENA [study](https://rdcu.be/enNYN) [PRJNA730913](https://www.ebi.ac.uk/ena/browser/view/PRJNA730913). 
* Feel free to replace it with your own realâ€‘world phenotype data once you are ready to analyse an actual study cohort.
* **Sample names** must *exactly* match the corresponding FASTQ file names.
  *(See the included `phenotype-test.csv` for an example.)*
* All phenotype variable names should be unique and descriptive.
* Ensure that categorical variables are coded consistently (e.g., `0/1` or `yes/no`)â€”the modelâ€‘building functions do **not** recast inconsistent encodings automatically.

---

## 2. EWAF Model Matrix (`models.csv`)

### Essentials for Model Matrix Construction

* **Parameters (`p`):** The total number of coefficients estimated by the model, including the intercept and any dummyâ€‘coded factors.
* **Minimum complete samples:** You must have at least *(pÂ +Â 1)* individuals with *no missing values* in all covariates.
  This is necessary so that the model retains at least one residual degree of freedom *(dfÂ =Â nÂ â€“Â rank(X)Â â‰¥Â 1)*, ensuring valid standard errors and *p*-values.
* **Contrast variables:** For binary indicators derived from multiâ€‘category factors, the rows representing the reference group will be set to `NA`.
  The **effective sample size** for each contrast is the number of rows with nonâ€‘missing values for that contrast variable.

> **Warning:**
> If the number of complete samples is less than the number of model parameters, modelâ€‘fitting functions (e.g., `ewaff.sites()` or any ordinary leastâ€‘squares GLM) will return `NA` or `NaN` for tâ€‘statistics and pâ€‘values due to zero residual degrees of freedom.

**Best practice:**
Ensure your phenotype file contains *more complete observations* (i.e., with no missing covariate values) than the total number of model parameters.

* **Important:**
  Variable names in your model matrix *must* **exactly match** the variable names in your phenotype file.

---

## 3. DNAm Panel Information (`panel.csv`)

This file specifies the CpG sites included in the DNAm target panel used for your study.
The format must match the following structure:

| chr    | start     | end       | source | details    |
| ------ | --------- | --------- | ------ | ---------- |
| chr1   | 17338766  | 17338766  | age    | cg20822990 |
| chr1   | 26855765  | 26855765  | age    | cg22512670 |
| chr1   | 28241577  | 28241577  | age    | cg25410668 |
| chr1   | 117665053 | 117665053 | age    | cg04400972 |
| chr1   | 169556022 | 169556022 | age    | cg16054275 |
| chr1   | 207997020 | 207997020 | age    | cg10501210 |

**Column descriptions:**

* `source`: Biological context or group (e.g., "age", "smoking") for the CpG site.
* `details`: CpG identifier.
* `chr`: Chromosome number.
* `start`, `end`: Genomic coordinates of the CpG site (usually identical for singleâ€‘site probes).

> **Note:**
> To use this pipeline for other panels, simply provide a `panel.csv` with the appropriate CpG list and annotation in the format above.

---

**Example panel:**
[DNAm lung cancer screening panel](https://github.com/MRCIEU/dnam-lung-cancer-screening-panel) is provided as a template.

**For further details and updates, see the original repository:**
ðŸ‘‰ [https://github.com/MRCIEU/dnam-lung-cancer-screening-panel](https://github.com/MRCIEU/dnam-lung-cancer-screening-panel)
